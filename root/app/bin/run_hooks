#!/bin/bash

#
# Run hook scripts
#

OVPN_HOOKS=${OVPN_HOOKS:-/config/hooks}

function usage() {
    echo "Usage: run_hooks HOOK_NAME [ARGS]"
    echo ""
    echo "Hooks:"
    echo "  up          saasas"
    echo "  down-pre    asasss"
    echo "  down-post   asasda"
    echo "  auth        asdasd"
}

# Check if hook name is set
if [ ! -n "$1" ]; then
    usage
    exit 1
fi

# Check if hook directory exist
if [ ! -d "$OVPN_HOOKS/$1" ]; then
    echo "Hook $OVPN_HOOKS/$1 directory does not exist"
    exit 2
fi

# Run each script and check for return code
for script in $OVPN_HOOKS/$1/*; do
    [ -e "$script" ] || continue

    # Execute only executable files
    if [ -f "$script" ] || [ -x "$script" ] || true; then
        # Run script and pass additional args to hooks
        if [ $# -gt 2 ]; then
            $script ${@:2}
        else
            $script
        fi

        # Check for error while executing script
        exit_status=$?
        if [ $exit_status -ne 0 ]; then
            # In case one of the hook files fails, everything fails
            echo "$script exited with $exit_status."
            exit $exit_status
        fi
    fi
done

# Exit with success
exit 0