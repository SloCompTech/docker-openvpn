#!/usr/bin/with-contenv bash
#
# Utility script
#

set -e

function usage() {
  echo 'Usage: ovpn COMMAND [ARGS..]'
  echo ''
  echo 'Commands:'
  echo '  backup [file] # Backup config (Default location: /config/backup)'
  echo '  pki crl # Updates CRL'
  echo '      init [nopass] # Inits PKI with CA (env MODULUS=... for dh.pem modulus)'
  echo '      reflect # Sync OpenVPN with PKI'
  echo '      run CMD # Run easyrsa command'
  echo '      rm|del  # Remove PKI'
  echo '  restore [file] # Restore config'
  echo '  subject add SUBNAME # TODO'
  echo '          gen-ovpn SUBNAME [file] # Generate .ovpn file'
  echo '          gen-pkg SUBNAME [file] # Generate config package'
  echo '          import-req FILE # Import signing request'
  echo '          renew SUBNAME # TODO'
  echo '          revoke SUBNAME'
  echo '          set SUBNAME OPTION [ARGS]'
}

# Lowercase command
command="$(echo $1 | tr '[:upper:]' '[:lower:]')"

case "$command" in
  backup)
    exec ovpn-backup ${@:2}
    ;;
  pki)
    exec ovpn-pki ${@:2}
    ;;
  restore)
    exec ovpn-restore ${@:2}
    ;;
  subject)
    exec ovpn-subject ${@:2}
    ;;
  *)
    usage
    ;;
esac
