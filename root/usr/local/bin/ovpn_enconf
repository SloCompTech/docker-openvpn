#!/bin/bash

#
#   Enables OpenVPN config example
#

# User permission fix
if [ "$USER" != "abc" ]; then
  RUNAS="sudo -E -u abc"
else
  RUNAS=""
fi

function usage() {
  echo "Usage: ovpn_enconf CONFIG_NAME [wizard args...]"
  echo ""
  echo "Configs:"
  local identifiers=() # Which identifiers we already printed out

  # Go through all identifiers
  for folder in /defaults/example/config/*
  do
      [ -d "$folder" ] || continue
      
      local folder_name="$(echo $folder | sed -E 's/^\/.*\/(.*)$/\1/')"
      
      # Check if we already printed out that identifer
      local found=0
      for i in "$identifiers"
      do
          if [ "$i" = "$folder_name" ]; then
              found=1
              break
          fi
      done
      if [ $found -eq 0 ]; then
          # Print out new identifier
          echo "$folder_name"
          identifiers=($identifiers $folder_name)
      fi
  done
}

if [ $# -lt 1 ] || [ "$1" == "help" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
  usage
  exit 1
fi

# Get wanted config name
config_name=$1
config_path=/defaults/example/config/$config_name

# Check if config exists
if [ ! -d $config_path ]; then
  echo "Config does not exist"
  exit 2
fi


# Configure copy destination
if [ -f "$config_path/wizard" ] && [ -x "$config_path/wizard" ]; then
  tmp_path=/tmp/wizard

  # Delete existing tmp directory
  if [ -d "$tmp_path" ]; then
    rm -rf $tmp_path
  fi

  # Copy config to temporary folder so it can be modified
  $RUNAS cp -r $config_path $tmp_path
  
  # Run wizard (with temporary path)
  currdir="$(pwd)"
  cd $tmp_path
  $RUNAS $tmp_path/wizard "$tmp_path" ${@:2}
  exit_code=$?
  cd $currdir
  
  # If wizard exists with code other than 0, return error
  if [ $exit_code -ne 0 ]; then
    echo "Error while executing wizard"
    exit $exit_code
  fi

  # Copy wizard finished files
  COPY_DIRS=(ccd client config hooks)
  for dir in "${COPY_DIRS[@]}"
  do
    [ -d "$tmp_path/$dir" ] || continue
    $RUNAS cp -r $tmp_path/$dir/* /config/openvpn/$dir/
  done

  # Remove temporary directory
  rm -rf $tmp_path
else
  # Directly copy files
  # Copy wizard finished files
  COPY_DIRS=(ccd client config hooks)
  for dir in "${COPY_DIRS[@]}"
  do
    [ -d "$config_path/$dir" ] || continue
    $RUNAS cp -r $config_path/$dir/* /config/openvpn/$dir/
  done

  # Wizard not available
  echo "Sorry, wizard not available for this config"
  echo ""
  echo "Please edit config files in /config/openvpn to suite your needs"
fi
