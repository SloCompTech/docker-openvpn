#!/bin/bash

#
#   Run hook scripts
#

function usage() {
  echo "Usage: run_hooks HOOK_NAME [ARGS]"
  echo ""
  echo "Hooks:"
  echo "  auth                On OpenVPN client authentication"
  echo "  client-connect      On OpenVPN client connected"
  echo "  client-disconnect   On OpenVPN client disconnected"
  echo "  finish              On container shutdown"
  echo "  init                On container power on"
  echo "  learn-address       Client Address & Routes validation"
  echo "  down                Before/After TUN interface closed"
  echo "  route-up            After routes are added"
  echo "  route-pre-down      Before routes are removed"
  echo "  tls-verify          On OpenVPN client certificate verificaton"
  echo "  up                  After TUN interface opened"
}

# Check if hook name is set
if [ -z "$1" ]; then
  usage
  exit 1
fi

# Check if hook directory exist
if [ ! -d "/config/openvpn/hooks/$1" ]; then
  echo "Hook /config/openvpn/hooks/$1 directory does not exist"
  exit 2
fi

# Run each script and check for return code
for script in /config/openvpn/hooks/$1/*
do
  { [ -f "$script" ] && [ -x "$script" ]; } || continue

  # Run script and pass additional args to hooks
  echo "Executing hook: $script"
  $script ${@:2}

  # Check for error while executing script
  exit_status=$?
  if [ $exit_status -ne 0 ]; then
    # In case one of the hook files fails, everything fails
    echo "$script exited with $exit_status."
    exit $exit_status
  fi
done
